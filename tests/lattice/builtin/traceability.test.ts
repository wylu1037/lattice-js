import { TraceabilityContract } from "@/lattice/builtin/index";
import { encodeBytes32Array } from "@/utils/bytes32";

describe("Traceability", () => {
  const traceability = new TraceabilityContract();

  it("should create a business", async () => {
    const business = traceability.createBusiness();
    expect(business).toBe("0x31");
  });

  it("should add a protocol", async () => {
    const actual = await traceability.createProtocol(
      1,
      Buffer.from(
        'syntax = "proto3";\n\nmessage Student {\n\tstring id = 1;\n\tstring name = 2;\n}'
      )
    );
    const expected =
      "0xef7e985800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000373796e746178203d202270726f746f33223b0a0a6d6573736167652053747564656e74207b0a09737472696e67206964203d20313b0a09737472696e67206e616d65203d20323b0a7d0000000000000000000000000000000000000000000000";
    expect(actual).toBe(expected);
  });

  it("should write a traceability", async () => {
    const actual = await traceability.writeTraceability({
      protocolUri: 8589934595,
      dataId: "1",
      data: encodeBytes32Array(Buffer.from([1, 2, 3, 4, 5, 6, 7, 8])),
      businessContractAddress: "zltc_YBomBNykwMqxm719giBL3VtYV4ABT9a8D"
    });
    const expected =
      "0x4131ff530000000000000000000000000000000000000000000000000000000200000003000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000561717f7922a233720ae38acaa4174cda0bf17660000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010102030405060708000000000000000000000000000000000000000000000000";
    expect(actual).toBe(expected);
  });

  it("should read a traceability", async () => {
    const actual = await traceability.readTraceability(
      "1",
      "zltc_YBomBNykwMqxm719giBL3VtYV4ABT9a8D"
    );
    const expected =
      "0x295adafb0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000561717f7922a233720ae38acaa4174cda0bf176600000000000000000000000000000000000000000000000000000000000000013100000000000000000000000000000000000000000000000000000000000000";
    expect(actual).toBe(expected);
  });
});
